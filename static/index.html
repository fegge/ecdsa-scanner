<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECDSA R-Value Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; color: #f0b90b; }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .summary-value { font-size: 1.8em; font-weight: bold; color: #f0b90b; }
        .summary-value.critical { color: #e74c3c; }
        .summary-label { color: #aaa; font-size: 0.85em; margin-top: 5px; }
        
        .main-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .main-tab {
            padding: 12px 30px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #aaa;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1em;
        }
        .main-tab.active { background: #f0b90b; color: #1a1a2e; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #f0b90b;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chain-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .chain-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }
        .chain-card.running { border-left-color: #2ecc71; }
        .chain-card.stopped { border-left-color: #e74c3c; }
        .chain-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .chain-name { font-weight: bold; }
        .chain-status {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .chain-status.running { background: #2ecc71; color: #000; }
        .chain-status.stopped { background: #e74c3c; }
        .chain-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
            color: #aaa;
        }
        .chain-stats span { color: #fff; }
        
        button {
            background: #f0b90b;
            color: #1a1a2e;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        button.danger { background: #e74c3c; color: white; }
        .controls { display: flex; gap: 10px; }
        
        .collision-list { max-height: 500px; overflow-y: auto; }
        .collision-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #f0b90b;
        }
        .r-value {
            font-family: monospace;
            font-size: 0.85em;
            color: #f0b90b;
            word-break: break-all;
            margin-bottom: 10px;
        }
        .tx-list { font-size: 0.85em; }
        .tx-item {
            display: flex;
            gap: 10px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .tx-item:last-child { border-bottom: none; }
        .chain-badge {
            background: #3498db;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .tx-item a { color: #f0b90b; text-decoration: none; }
        .tx-item a:hover { text-decoration: underline; }
        
        .key-card {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .key-card h4 { color: #e74c3c; margin: 0; }
        .key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .key-balance {
            font-size: 1.1em;
            font-weight: bold;
            color: #888;
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 6px;
        }
        .key-balance.balance-positive {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .key-field { margin: 10px 0; }
        .key-field label { color: #888; font-size: 0.85em; display: block; margin-bottom: 4px; }
        .key-field .value {
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 4px;
            word-break: break-all;
        }
        .key-field .private-key { color: #e74c3c; cursor: pointer; }
        
        .log-container {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-timestamp { color: #888; margin-right: 10px; }
        .log-level { margin-right: 8px; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; }
        .log-level.INFO { background: rgba(52, 152, 219, 0.3); color: #3498db; }
        .log-level.WARN { background: rgba(243, 156, 18, 0.3); color: #f39c12; }
        .log-level.ERROR { background: rgba(231, 76, 60, 0.3); color: #e74c3c; }
        
        .overall-status {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .overall-status.healthy {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .overall-status.healthy h2 { color: #2ecc71; }
        .overall-status.unhealthy {
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        .overall-status.unhealthy h2 { color: #e74c3c; }
        .overall-status.degraded {
            background: rgba(243, 156, 18, 0.15);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }
        .overall-status.degraded h2 { color: #f39c12; }
        .overall-status p { color: #aaa; margin-top: 5px; }
        
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .health-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
        }
        .health-card h3 {
            color: #f0b90b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .health-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
        }
        .health-status.unhealthy { background: #e74c3c; }
        .health-status.warning { background: #f39c12; }
        .health-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .health-metric:last-child { border-bottom: none; }
        .health-metric-label { color: #aaa; }
        .health-metric-value { color: #fff; font-weight: bold; }
        .health-metric-value.good { color: #2ecc71; }
        .health-metric-value.warning { color: #f39c12; }
        .health-metric-value.bad { color: #e74c3c; }
        
        .chain-health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .chain-health-item {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 12px;
        }
        .chain-health-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .chain-health-name { font-weight: bold; }
        .chain-health-status {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .chain-health-status.healthy { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .chain-health-status.stopped { background: rgba(255, 255, 255, 0.1); color: #888; }
        .chain-health-status.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .chain-health-details { font-size: 0.8em; color: #888; }
        
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #2ecc71;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Multi-Chain ECDSA R-Value Scanner</h1>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-value" id="totalRValues">-</div>
                <div class="summary-label">R-Values Indexed</div>
            </div>
            <div class="summary-card">
                <div class="summary-value critical" id="totalCollisions">-</div>
                <div class="summary-label">Collisions Found</div>
            </div>
            <div class="summary-card">
                <div class="summary-value critical" id="recoveredKeys">-</div>
                <div class="summary-label">Keys Recovered</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="recoveredNonces">-</div>
                <div class="summary-label">Nonces Known</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="pendingComponents">-</div>
                <div class="summary-label">Pending Components</div>
            </div>
        </div>

        <div class="main-tabs">
            <button class="main-tab active" onclick="showTab('scanner')">Scanner</button>
            <button class="main-tab" onclick="showTab('recovery')">Recovery</button>
            <button class="main-tab" onclick="showTab('health')">Health</button>
        </div>

        <div id="scannerTab" class="tab-content active">
            <div class="section">
                <h2>
                    Chain Scanners
                    <div class="controls">
                        <button onclick="startAll()">Start All</button>
                        <button class="danger" onclick="stopAll()">Stop All</button>
                    </div>
                </h2>
                <div class="chain-grid" id="chainGrid"></div>
            </div>
        </div>

        <div id="recoveryTab" class="tab-content">
            <div class="section">
                <h2>
                    Recovered Private Keys
                    <button id="autoRecoveryBtn" onclick="toggleAutoRecovery()">Auto-Recovery: ON</button>
                </h2>
                <p style="color: #888; margin-bottom: 15px;">Private keys recovered from ECDSA nonce reuse vulnerabilities.</p>
                <div id="keysList"></div>
            </div>

            <div class="section">
                <h2>R-Value Collisions</h2>
                <p style="color: #888; margin-bottom: 15px;">Detected nonce reuse - same R-value used in multiple transactions.</p>
                <div class="collision-list" id="collisionList"></div>
            </div>

            <div class="section">
                <h2>Cross-Key Recovery Data</h2>
                <p style="color: #888; margin-bottom: 15px;">Nonces that can help recover keys from other addresses sharing the same R-value.</p>
                <div id="noncesList"></div>
            </div>

            <div class="section">
                <h2>Pending Components</h2>
                <p style="color: #888; margin-bottom: 15px;">Cross-key collisions awaiting more data to become solvable.</p>
                <div id="componentsList"></div>
            </div>
        </div>

        <div id="healthTab" class="tab-content">
            <div id="overallStatus" class="overall-status healthy">
                <h2>System Healthy</h2>
                <p>All systems operational</p>
            </div>

            <div class="health-grid">
                <div class="health-card">
                    <h3><span class="health-status" id="dbHealthStatus"></span> Database</h3>
                    <div class="health-metric">
                        <span class="health-metric-label">Connection</span>
                        <span class="health-metric-value" id="dbConnected">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Latency</span>
                        <span class="health-metric-value" id="dbLatency">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Open Connections</span>
                        <span class="health-metric-value" id="dbConnections">-</span>
                    </div>
                </div>

                <div class="health-card">
                    <h3><span class="health-status" id="scannerHealthStatus"></span> Scanner</h3>
                    <div class="health-metric">
                        <span class="health-metric-label">Active Chains</span>
                        <span class="health-metric-value" id="activeChains">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Total Errors</span>
                        <span class="health-metric-value" id="totalErrors">-</span>
                    </div>
                </div>

                <div class="health-card">
                    <h3><span class="health-status" id="throughputHealthStatus"></span> Throughput</h3>
                    <div class="health-metric">
                        <span class="health-metric-label">Transactions/second</span>
                        <span class="health-metric-value" id="currentTps">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Blocks Behind (Total)</span>
                        <span class="health-metric-value" id="totalBlocksBehind">-</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Chain Health Status</h2>
                <div class="chain-health-grid" id="chainHealthGrid"></div>
            </div>

            <div class="section">
                <h2>System Logs</h2>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const explorers = {
            1: 'https://etherscan.io',
            56: 'https://bscscan.com',
            137: 'https://polygonscan.com',
            42161: 'https://arbiscan.io',
            43114: 'https://snowtrace.io',
            250: 'https://ftmscan.com',
            10: 'https://optimistic.etherscan.io',
            8453: 'https://basescan.org',
            324: 'https://explorer.zksync.io',
            100: 'https://gnosisscan.io',
            42220: 'https://celoscan.io'
        };

        function formatNumber(n) {
            return n?.toLocaleString() || '-';
        }

        // TPS tracking
        let lastRValues = null;
        let lastRValuesTime = null;
        let currentTps = 0;

        function showTab(name) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + 'Tab').classList.add('active');
            
            if (name === 'recovery') fetchRecoveryData();
            if (name === 'health') fetchHealthData();
        }

        async function fetchStats() {
            try {
                const resp = await fetch('/api/stats');
                const stats = await resp.json();
                const now = Date.now();
                
                // Calculate TPS
                if (lastRValues !== null && lastRValuesTime !== null) {
                    const deltaR = stats.total_r_values - lastRValues;
                    const deltaT = (now - lastRValuesTime) / 1000; // seconds
                    if (deltaT > 0 && deltaR >= 0) {
                        currentTps = deltaR / deltaT;
                    }
                }
                lastRValues = stats.total_r_values;
                lastRValuesTime = now;
                
                document.getElementById('totalRValues').textContent = formatNumber(stats.total_r_values);
                document.getElementById('totalCollisions').textContent = formatNumber(stats.total_collisions);
                document.getElementById('recoveredKeys').textContent = formatNumber(stats.recovered_keys);
                document.getElementById('recoveredNonces').textContent = formatNumber(stats.recovered_nonces);
                document.getElementById('pendingComponents').textContent = formatNumber(stats.pending_components);
                
                const btn = document.getElementById('autoRecoveryBtn');
                btn.textContent = 'Auto-Recovery: ' + (stats.auto_recovery ? 'ON' : 'OFF');
                btn.className = stats.auto_recovery ? '' : 'danger';

                const grid = document.getElementById('chainGrid');
                if (stats.chains?.length) {
                    grid.innerHTML = stats.chains.map(c => `
                        <div class="chain-card ${c.running ? 'running' : 'stopped'}">
                            <div class="chain-header">
                                <span class="chain-name">${c.chain}</span>
                                <span class="chain-status ${c.running ? 'running' : 'stopped'}">
                                    ${c.running ? '<span class="spinner"></span>Running' : 'Stopped'}
                                </span>
                            </div>
                            <div class="chain-stats">
                                <div>Block: <span>${formatNumber(c.current_block)}</span></div>
                                <div>Latest: <span>${formatNumber(c.latest_block)}</span></div>
                                <div>Behind: <span>${formatNumber(c.latest_block - c.current_block)}</span></div>
                                <div>Errors: <span>${c.error_count}</span></div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        async function fetchRecoveryData() {
            // Fetch all recovery-related data
            await Promise.all([fetchKeys(), fetchCollisions(), fetchNonces(), fetchComponents()]);
        }

        async function fetchCollisions() {
            try {
                const resp = await fetch('/api/collisions');
                const collisions = await resp.json();
                
                const list = document.getElementById('collisionList');
                if (!collisions?.length) {
                    list.innerHTML = '<p style="color: #888; text-align: center;">No collisions detected yet.</p>';
                    return;
                }

                list.innerHTML = collisions.map(c => `
                    <div class="collision-item">
                        <div class="r-value">R: ${c.r_value}</div>
                        <div class="tx-list">
                            ${c.tx_refs.map(tx => {
                                const explorer = explorers[tx.chain_id] || '';
                                return `
                                    <div class="tx-item">
                                        <span class="chain-badge">${tx.chain_name || 'Chain ' + tx.chain_id}</span>
                                        <a href="${explorer}/tx/${tx.tx_hash}" target="_blank">
                                            ${tx.tx_hash.substring(0, 20)}...${tx.tx_hash.slice(-8)}
                                        </a>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Collisions error:', e);
            }
        }

        async function fetchKeys() {
            try {
                const resp = await fetch('/api/recovered-keys');
                const keys = await resp.json();
                
                const list = document.getElementById('keysList');
                if (!keys?.length) {
                    list.innerHTML = '<p style="color: #888; text-align: center;">No keys recovered yet.</p>';
                    return;
                }

                list.innerHTML = keys.map(k => {
                    const explorer = explorers[k.chain_id] || '';
                    const hasBalance = k.balance_eth && k.balance_eth !== '0';
                    const balanceClass = hasBalance ? 'balance-positive' : '';
                    return `
                        <div class="key-card">
                            <div class="key-header">
                                <h4>${k.chain_name || 'Chain ' + k.chain_id} - Compromised Address</h4>
                                <div class="key-balance ${balanceClass}">
                                    ${k.balance_eth || '0'} ${getChainSymbol(k.chain_id)}
                                </div>
                            </div>
                            <div class="key-field">
                                <label>Address</label>
                                <div class="value">
                                    <a href="${explorer}/address/${k.address}" target="_blank" style="color: #f0b90b;">${k.address}</a>
                                </div>
                            </div>
                            <div class="key-field">
                                <label>Private Key (click to copy)</label>
                                <div class="value private-key" onclick="navigator.clipboard.writeText('${k.private_key}').then(() => alert('Copied!'))">
                                    ${k.private_key}
                                </div>
                            </div>
                            <div class="key-field">
                                <label>Transactions</label>
                                <div class="value" style="font-size: 0.85em;">
                                    ${k.tx_hashes?.map(tx => `<a href="${explorer}/tx/${tx}" target="_blank" style="color: #f0b90b;">${tx.substring(0, 16)}...</a>`).join(' | ') || '-'}
                                </div>
                            </div>
                            <div style="color: #888; font-size: 0.8em; margin-top: 10px;">Recovered: ${k.created_at}</div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Keys error:', e);
            }
        }

        function getChainSymbol(chainId) {
            const symbols = {
                1: 'ETH', 56: 'BNB', 137: 'MATIC', 42161: 'ETH', 43114: 'AVAX',
                250: 'FTM', 10: 'ETH', 8453: 'ETH', 324: 'ETH', 100: 'xDAI', 42220: 'CELO'
            };
            return symbols[chainId] || 'ETH';
        }

        async function fetchNonces() {
            try {
                const resp = await fetch('/api/recovered-nonces');
                const nonces = await resp.json();
                
                const list = document.getElementById('noncesList');
                if (!nonces?.length) {
                    list.innerHTML = '<p style="color: #888; text-align: center;">No cross-key nonces available.</p>';
                    return;
                }

                list.innerHTML = `
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.1);">
                                    <th style="padding: 12px; text-align: left; color: #f0b90b;">R Value</th>
                                    <th style="padding: 12px; text-align: left; color: #f0b90b;">Nonce (k)</th>
                                    <th style="padding: 12px; text-align: left; color: #f0b90b;">Source Key ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${nonces.map(n => `
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        <td style="padding: 12px; font-family: monospace; color: #f0b90b;">${n.r_value.substring(0, 20)}...${n.r_value.slice(-8)}</td>
                                        <td style="padding: 12px; font-family: monospace;">${n.k_value.substring(0, 20)}...${n.k_value.slice(-8)}</td>
                                        <td style="padding: 12px;">#${n.derived_from_key_id}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (e) {
                console.error('Nonces error:', e);
            }
        }

        async function fetchComponents() {
            try {
                const resp = await fetch('/api/pending-components');
                const comps = await resp.json();
                
                const list = document.getElementById('componentsList');
                if (!comps?.length) {
                    list.innerHTML = '<p style="color: #888; text-align: center;">No pending components.</p>';
                    return;
                }

                list.innerHTML = comps.map(c => `
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #9b59b6;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #9b59b6; font-weight: bold;">Component #${c.id}</span>
                            <span style="color: #888;">${c.equations} equations / ${c.unknowns} unknowns (need ${c.unknowns - c.equations} more)</span>
                        </div>
                        <div style="font-size: 0.85em; color: #aaa;">
                            <div><strong>Addresses:</strong> ${c.addresses?.length || 0}</div>
                            <div><strong>R-Values:</strong> ${c.r_values?.length || 0}</div>
                            <div><strong>Transactions:</strong> ${c.tx_hashes?.length || 0}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Components error:', e);
            }
        }

        async function fetchHealthData() {
            await Promise.all([fetchHealth(), fetchLogs()]);
        }

        async function fetchHealth() {
            try {
                const [healthResp, statsResp] = await Promise.all([
                    fetch('/api/health'),
                    fetch('/api/stats')
                ]);
                const health = await healthResp.json();
                const stats = await statsResp.json();

                // Database health
                const dbStatus = document.getElementById('dbHealthStatus');
                const dbConnected = document.getElementById('dbConnected');
                const dbLatency = document.getElementById('dbLatency');
                const dbConnections = document.getElementById('dbConnections');

                if (health.database?.connected) {
                    dbStatus.className = 'health-status';
                    dbConnected.textContent = 'Connected';
                    dbConnected.className = 'health-metric-value good';
                } else {
                    dbStatus.className = 'health-status unhealthy';
                    dbConnected.textContent = 'Disconnected';
                    dbConnected.className = 'health-metric-value bad';
                }

                const latency = health.database?.latency_ms || 0;
                dbLatency.textContent = latency + ' ms';
                dbLatency.className = latency < 50 ? 'health-metric-value good' : 
                                      latency < 200 ? 'health-metric-value warning' : 'health-metric-value bad';
                dbConnections.textContent = health.database?.open_connections || 0;

                // Scanner health
                const scannerStatus = document.getElementById('scannerHealthStatus');
                const activeChains = document.getElementById('activeChains');
                const totalErrors = document.getElementById('totalErrors');

                const chains = health.chains || [];
                const runningCount = chains.filter(c => c.running).length;
                const totalErrorCount = chains.reduce((sum, c) => sum + (c.error_count || 0), 0);

                activeChains.textContent = `${runningCount} / ${chains.length}`;
                totalErrors.textContent = totalErrorCount;
                totalErrors.className = totalErrorCount > 100 ? 'health-metric-value bad' :
                                        totalErrorCount > 10 ? 'health-metric-value warning' : 'health-metric-value good';

                scannerStatus.className = runningCount === 0 ? 'health-status unhealthy' :
                                          totalErrorCount > 50 ? 'health-status warning' : 'health-status';

                // Throughput
                const throughputStatus = document.getElementById('throughputHealthStatus');
                const currentTpsEl = document.getElementById('currentTps');
                const totalBlocksBehind = document.getElementById('totalBlocksBehind');

                currentTpsEl.textContent = currentTps.toFixed(1);

                let blocksBehind = 0;
                if (stats.chains) {
                    blocksBehind = stats.chains.reduce((sum, c) => sum + Math.max(0, (c.latest_block || 0) - (c.current_block || 0)), 0);
                }
                totalBlocksBehind.textContent = formatNumber(blocksBehind);
                totalBlocksBehind.className = blocksBehind > 10000 ? 'health-metric-value bad' :
                                              blocksBehind > 1000 ? 'health-metric-value warning' : 'health-metric-value good';
                throughputStatus.className = blocksBehind > 10000 ? 'health-status warning' : 'health-status';

                // Chain health grid
                const chainHealthGrid = document.getElementById('chainHealthGrid');
                chainHealthGrid.innerHTML = chains.map(chain => {
                    const chainStats = stats.chains?.find(c => c.chain === chain.name) || {};
                    const behind = Math.max(0, (chainStats.latest_block || 0) - (chainStats.current_block || 0));
                    let statusClass = 'healthy';
                    let statusText = 'Healthy';
                    if (!chain.running) {
                        statusClass = 'stopped';
                        statusText = 'Stopped';
                    } else if (chain.error_count > 10) {
                        statusClass = 'error';
                        statusText = 'Errors';
                    }

                    return `
                        <div class="chain-health-item">
                            <div class="chain-health-header">
                                <span class="chain-health-name">${chain.name}</span>
                                <span class="chain-health-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="chain-health-details">
                                Errors: ${chain.error_count || 0} | Behind: ${formatNumber(behind)}
                            </div>
                        </div>
                    `;
                }).join('');

                // Overall status
                const overallStatus = document.getElementById('overallStatus');
                const dbHealthy = health.database?.connected;
                const scannersHealthy = runningCount > 0 && totalErrorCount < 100;

                if (!dbHealthy) {
                    overallStatus.className = 'overall-status unhealthy';
                    overallStatus.innerHTML = '<h2>System Unhealthy</h2><p>Database connection failed</p>';
                } else if (!scannersHealthy) {
                    overallStatus.className = 'overall-status degraded';
                    const issues = [];
                    if (runningCount === 0) issues.push('No chains running');
                    if (totalErrorCount >= 100) issues.push('High error count');
                    overallStatus.innerHTML = `<h2>System Degraded</h2><p>${issues.join(', ')}</p>`;
                } else {
                    overallStatus.className = 'overall-status healthy';
                    overallStatus.innerHTML = '<h2>System Healthy</h2><p>All systems operational</p>';
                }
            } catch (e) {
                console.error('Health error:', e);
            }
        }

        async function fetchLogs() {
            try {
                const resp = await fetch('/api/logs');
                const logs = await resp.json();
                
                const container = document.getElementById('logContainer');
                if (!logs?.length) {
                    container.innerHTML = '<p style="color: #888;">No logs yet.</p>';
                    return;
                }

                container.innerHTML = logs.map(l => `
                    <div class="log-entry">
                        <span class="log-timestamp">${l.timestamp}</span>
                        <span class="log-level ${l.level || 'INFO'}">${l.level || 'INFO'}</span>
                        <span>${l.message}</span>
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            } catch (e) {
                console.error('Logs error:', e);
            }
        }

        async function startAll() {
            await fetch('/api/start', { method: 'POST' });
            fetchStats();
        }

        async function stopAll() {
            await fetch('/api/stop', { method: 'POST' });
            fetchStats();
        }

        async function toggleAutoRecovery() {
            await fetch('/api/recovery/toggle', { method: 'POST' });
            fetchStats();
        }

        // Initial load and refresh
        fetchStats();
        setInterval(fetchStats, 3000);
        setInterval(() => {
            const active = document.querySelector('.tab-content.active');
            if (active?.id === 'recoveryTab') fetchRecoveryData();
            if (active?.id === 'healthTab') fetchHealthData();
        }, 5000);
    </script>
</body>
</html>
