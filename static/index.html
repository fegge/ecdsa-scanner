<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain R-Value Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #f0b90b;
            text-shadow: 0 0 10px rgba(240, 185, 11, 0.5);
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #f0b90b;
        }
        .summary-value.critical { color: #e74c3c; }
        .summary-label {
            color: #aaa;
            font-size: 0.85em;
            margin-top: 5px;
        }
        .chains-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chains-section h2 {
            color: #f0b90b;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chain-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .chain-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }
        .chain-card.running { border-left-color: #2ecc71; }
        .chain-card.stopped { border-left-color: #e74c3c; }
        .chain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .chain-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .chain-status {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .chain-status.running { background: #2ecc71; color: #000; }
        .chain-status.stopped { background: #e74c3c; }
        .chain-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85em;
            color: #aaa;
        }
        .chain-stats span { color: #fff; }
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #f0b90b;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        .duplicate-list { max-height: 600px; overflow-y: auto; }
        .duplicate-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #f0b90b;
        }
        .duplicate-item.critical {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.15);
        }
        .duplicate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .r-value {
            font-family: monospace;
            font-size: 0.9em;
            color: #f0b90b;
            word-break: break-all;
        }
        .duplicate-item.critical .r-value { color: #e74c3c; }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .badge.same-key { background: #e74c3c; }
        .badge.cross-key { background: #3498db; }
        .badge.cross-chain { background: #9b59b6; }
        .entries-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85em;
        }
        .entries-table th {
            text-align: left;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            color: #f0b90b;
        }
        .entries-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .entries-table .chain-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            background: #3498db;
        }
        .entries-table a {
            color: #f0b90b;
            text-decoration: none;
        }
        .entries-table a:hover { text-decoration: underline; }
        .address { font-family: monospace; }
        button {
            background: #f0b90b;
            color: #1a1a2e;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(240, 185, 11, 0.4); }
        button.danger { background: #e74c3c; color: white; }
        button.small { padding: 4px 12px; font-size: 0.8em; }
        .controls {
            display: flex;
            gap: 10px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #aaa;
            cursor: pointer;
            border-radius: 8px;
        }
        .tab.active {
            background: #f0b90b;
            color: #1a1a2e;
        }
        .info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #2ecc71;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .explorer-links {
            font-size: 0.75em;
            color: #888;
        }
        .main-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .main-tab {
            padding: 12px 30px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #aaa;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1em;
        }
        .main-tab.active {
            background: #f0b90b;
            color: #1a1a2e;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .log-container {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            max-height: 600px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }
        .log-message {
            color: #eee;
        }
        .log-message.error {
            color: #e74c3c;
        }
        .log-message.warning {
            color: #f39c12;
        }
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .health-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
        }
        .health-card h3 {
            color: #f0b90b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .health-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
        }
        .health-status.unhealthy {
            background: #e74c3c;
        }
        .health-status.warning {
            background: #f39c12;
        }
        .health-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .health-metric:last-child {
            border-bottom: none;
        }
        .health-metric-label {
            color: #aaa;
        }
        .health-metric-value {
            color: #fff;
            font-weight: bold;
        }
        .health-metric-value.good {
            color: #2ecc71;
        }
        .health-metric-value.warning {
            color: #f39c12;
        }
        .health-metric-value.bad {
            color: #e74c3c;
        }
        .chain-health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .chain-health-item {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .chain-health-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chain-health-name {
            font-weight: bold;
        }
        .chain-health-status {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .chain-health-status.healthy {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        .chain-health-status.circuit-open {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        .chain-health-status.stopped {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }
        .chain-health-details {
            font-size: 0.8em;
            color: #888;
        }
        .overall-status {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .overall-status.healthy {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .overall-status.unhealthy {
            background: rgba(231, 76, 60, 0.15);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        .overall-status.degraded {
            background: rgba(243, 156, 18, 0.15);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }
        .overall-status h2 {
            margin-bottom: 5px;
        }
        .overall-status.healthy h2 {
            color: #2ecc71;
        }
        .overall-status.unhealthy h2 {
            color: #e74c3c;
        }
        .overall-status.degraded h2 {
            color: #f39c12;
        }
        .overall-status p {
            color: #aaa;
            font-size: 0.9em;
        }
        .log-level-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 8px;
            font-weight: bold;
        }
        .log-level-badge.INFO {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }
        .log-level-badge.WARN {
            background: rgba(243, 156, 18, 0.3);
            color: #f39c12;
        }
        .log-level-badge.ERROR {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Multi-Chain ECDSA R-Value Scanner</h1>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-value" id="totalTx">-</div>
                <div class="summary-label">Total Transactions</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="totalSigs">-</div>
                <div class="summary-label">Signatures Stored</div>
            </div>
            <div class="summary-card">
                <div class="summary-value critical" id="sameKeyDups">-</div>
                <div class="summary-label">Same Key Duplicates</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="crossKeyDups">-</div>
                <div class="summary-label">Cross-Key Duplicates</div>
            </div>
            <div class="summary-card">
                <div class="summary-value" id="crossChainDups">-</div>
                <div class="summary-label">Cross-Chain Duplicates</div>
            </div>
        </div>

        <div class="main-tabs">
            <button class="main-tab active" onclick="showMainTab('scanner')">Scanner</button>
            <button class="main-tab" onclick="showMainTab('logs')">Logs</button>
        </div>

        <div id="scannerTab" class="tab-content active">
            <div class="chains-section">
                <h2>
                    Chain Scanners
                    <div class="controls">
                        <button onclick="startAll()">Start All</button>
                        <button class="danger" onclick="stopAll()">Stop All</button>
                    </div>
                </h2>
                <div class="chain-grid" id="chainGrid"></div>
            </div>

            <div class="section">
                <h2>Duplicate R Values Found</h2>
                <div class="tabs">
                    <button class="tab active" onclick="showTab('all')">All</button>
                    <button class="tab" onclick="showTab('same-key')">Same Key</button>
                    <button class="tab" onclick="showTab('cross-key')">Cross-Key</button>
                </div>
                <div class="duplicate-list" id="duplicateList">
                    <p style="color: #888; text-align: center;">Scanning for duplicates...</p>
                </div>
            </div>
        </div>

        <div id="logsTab" class="tab-content">
            <div id="overallStatus" class="overall-status healthy">
                <h2>System Healthy</h2>
                <p>All systems operational</p>
            </div>

            <div class="health-grid">
                <div class="health-card">
                    <h3><span class="health-status" id="dbHealthStatus"></span> Database</h3>
                    <div class="health-metric">
                        <span class="health-metric-label">Connection</span>
                        <span class="health-metric-value" id="dbConnected">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Latency</span>
                        <span class="health-metric-value" id="dbLatency">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Open Connections</span>
                        <span class="health-metric-value" id="dbConnections">-</span>
                    </div>
                </div>

                <div class="health-card">
                    <h3><span class="health-status" id="scannerHealthStatus"></span> Scanner</h3>
                    <div class="health-metric">
                        <span class="health-metric-label">Active Chains</span>
                        <span class="health-metric-value" id="activeChains">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Write Errors</span>
                        <span class="health-metric-value" id="writeErrors">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Circuits Open</span>
                        <span class="health-metric-value" id="circuitsOpen">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Total Errors</span>
                        <span class="health-metric-value" id="totalErrors">-</span>
                    </div>
                </div>

                <div class="health-card">
                    <h3><span class="health-status" id="throughputHealthStatus"></span> Throughput</h3>
                    <div class="health-metric">
                        <span class="health-metric-label">Total Transactions</span>
                        <span class="health-metric-value" id="healthTotalTx">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Total Signatures</span>
                        <span class="health-metric-value" id="healthTotalSigs">-</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">Blocks Behind (Total)</span>
                        <span class="health-metric-value" id="totalBlocksBehind">-</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Chain Health Status</h2>
                <div class="chain-health-grid" id="chainHealthGrid">
                    <p style="color: #888;">Loading chain health...</p>
                </div>
            </div>

            <div class="section">
                <h2>Log Output</h2>
                <div class="log-container" id="logContainer">
                    <p style="color: #888; text-align: center;">Loading logs...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chainExplorers = {
            'Ethereum': 'https://etherscan.io',
            'BSC': 'https://bscscan.com',
            'Polygon': 'https://polygonscan.com',
            'Arbitrum': 'https://arbiscan.io',
            'Avalanche': 'https://snowtrace.io',
            'Fantom': 'https://ftmscan.com',
            'Optimism': 'https://optimistic.etherscan.io',
            'Base': 'https://basescan.org',
            'zkSync': 'https://explorer.zksync.io',
            'Cronos': 'https://cronoscan.com',
            'Gnosis': 'https://gnosisscan.io',
            'Celo': 'https://celoscan.io'
        };

        let currentTab = 'all';

        function formatNumber(n) {
            if (n === undefined || n === null) return '-';
            return n.toLocaleString();
        }

        async function fetchStats() {
            try {
                const resp = await fetch('/api/stats');
                const stats = await resp.json();
                
                document.getElementById('totalTx').textContent = formatNumber(stats.total_tx_scanned);
                document.getElementById('totalSigs').textContent = formatNumber(stats.total_signatures);
                document.getElementById('sameKeyDups').textContent = formatNumber(stats.duplicate_same_key);
                document.getElementById('crossKeyDups').textContent = formatNumber(stats.duplicate_cross_key);
                document.getElementById('crossChainDups').textContent = formatNumber(stats.duplicate_cross_chain);

                // Update chain cards
                const grid = document.getElementById('chainGrid');
                if (stats.chains && stats.chains.length > 0) {
                    grid.innerHTML = stats.chains.map(chain => `
                        <div class="chain-card ${chain.running ? 'running' : 'stopped'}">
                            <div class="chain-header">
                                <span class="chain-name">${chain.chain}</span>
                                <span class="chain-status ${chain.running ? 'running' : 'stopped'}">
                                    ${chain.running ? '<span class="spinner"></span>Running' : 'Stopped'}
                                </span>
                            </div>
                            <div class="chain-stats">
                                <div>Current: <span>${formatNumber(chain.current_block)}</span></div>
                                <div>Latest: <span>${formatNumber(chain.latest_block)}</span></div>
                                <div>Scanned: <span>${formatNumber(chain.tx_scanned)}</span></div>
                                <div>Behind: <span>${formatNumber(chain.latest_block - chain.current_block)}</span></div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        }

        async function fetchDuplicates() {
            try {
                let endpoint = '/api/duplicates';
                if (currentTab === 'same-key') endpoint = '/api/duplicates/same-key';
                else if (currentTab === 'cross-key') endpoint = '/api/duplicates/cross-key';

                const resp = await fetch(endpoint);
                const duplicates = await resp.json();
                
                const list = document.getElementById('duplicateList');
                if (!duplicates || duplicates.length === 0) {
                    list.innerHTML = '<p style="color: #888; text-align: center;">No duplicates found yet. Keep scanning!</p>';
                    return;
                }

                list.innerHTML = duplicates.map(d => {
                    const chains = [...new Set(d.entries.map(e => e.chain))];
                    const isCrossChain = chains.length > 1;
                    
                    return `
                    <div class="duplicate-item ${d.same_key ? 'critical' : ''}">
                        <div class="duplicate-header">
                            <div>
                                <span class="badge ${d.same_key ? 'same-key' : 'cross-key'}">
                                    ${d.same_key ? 'SAME KEY - Vulnerable!' : 'Cross-Key'}
                                </span>
                                ${isCrossChain ? '<span class="badge cross-chain" style="margin-left:5px;">Cross-Chain</span>' : ''}
                                <span style="margin-left: 10px; color: #888;">Count: ${d.count}</span>
                            </div>
                        </div>
                        <div class="r-value">R: ${d.r_value}</div>
                        <table class="entries-table">
                            <thead>
                                <tr>
                                    <th>Chain</th>
                                    <th>Address</th>
                                    <th>Transaction</th>
                                    <th>Block</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${d.entries.slice(0, 10).map(e => {
                                    const explorer = chainExplorers[e.chain] || '';
                                    return `
                                    <tr>
                                        <td><span class="chain-badge">${e.chain}</span></td>
                                        <td class="address">
                                            <a href="${explorer}/address/${e.address}" target="_blank">
                                                ${e.address.substring(0, 10)}...${e.address.substring(38)}
                                            </a>
                                        </td>
                                        <td>
                                            <a href="${explorer}/tx/${e.tx_hash}" target="_blank">
                                                ${e.tx_hash.substring(0, 10)}...${e.tx_hash.substring(58)}
                                            </a>
                                        </td>
                                        <td>${formatNumber(e.block_number)}</td>
                                    </tr>
                                    `;
                                }).join('')}
                                ${d.entries.length > 10 ? `<tr><td colspan="4" style="color:#888;">... and ${d.entries.length - 10} more</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                `}).join('');
            } catch (e) {
                console.error('Failed to fetch duplicates:', e);
            }
        }

        function showTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            fetchDuplicates();
        }

        async function startAll() {
            await fetch('/api/start', { method: 'POST' });
            fetchStats();
        }

        async function stopAll() {
            await fetch('/api/stop', { method: 'POST' });
            fetchStats();
        }

        let currentMainTab = 'scanner';
        let healthData = null;
        let statsData = null;

        function showMainTab(tab) {
            currentMainTab = tab;
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            if (tab === 'logs') {
                fetchHealth();
                fetchLogs();
            }
        }

        async function fetchHealth() {
            try {
                const [healthResp, statsResp] = await Promise.all([
                    fetch('/api/health'),
                    fetch('/api/stats')
                ]);
                healthData = await healthResp.json();
                statsData = await statsResp.json();
                updateHealthUI();
            } catch (e) {
                console.error('Failed to fetch health:', e);
            }
        }

        function updateHealthUI() {
            if (!healthData || !statsData) return;

            // Database health
            const dbStatus = document.getElementById('dbHealthStatus');
            const dbConnected = document.getElementById('dbConnected');
            const dbLatency = document.getElementById('dbLatency');
            const dbConnections = document.getElementById('dbConnections');

            if (healthData.database.connected) {
                dbStatus.className = 'health-status';
                dbConnected.textContent = 'Connected';
                dbConnected.className = 'health-metric-value good';
            } else {
                dbStatus.className = 'health-status unhealthy';
                dbConnected.textContent = 'Disconnected';
                dbConnected.className = 'health-metric-value bad';
            }

            const latency = healthData.database.latency_ms;
            dbLatency.textContent = latency + ' ms';
            if (latency < 50) {
                dbLatency.className = 'health-metric-value good';
            } else if (latency < 200) {
                dbLatency.className = 'health-metric-value warning';
            } else {
                dbLatency.className = 'health-metric-value bad';
            }

            dbConnections.textContent = healthData.database.open_connections;

            // Scanner health
            const scannerStatus = document.getElementById('scannerHealthStatus');
            const activeChains = document.getElementById('activeChains');
            const writeErrors = document.getElementById('writeErrors');
            const circuitsOpen = document.getElementById('circuitsOpen');
            const totalErrors = document.getElementById('totalErrors');

            const runningChains = healthData.chains.filter(c => c.running).length;
            const openCircuits = healthData.chains.filter(c => c.circuit_open).length;
            const totalErrorCount = healthData.chains.reduce((sum, c) => sum + c.error_count, 0);

            activeChains.textContent = `${runningChains} / ${healthData.chains.length}`;
            writeErrors.textContent = statsData.write_errors || 0;
            writeErrors.className = statsData.write_errors > 0 ? 'health-metric-value warning' : 'health-metric-value good';
            
            circuitsOpen.textContent = openCircuits;
            circuitsOpen.className = openCircuits > 0 ? 'health-metric-value bad' : 'health-metric-value good';
            
            totalErrors.textContent = totalErrorCount;
            totalErrors.className = totalErrorCount > 100 ? 'health-metric-value bad' : 
                                   totalErrorCount > 10 ? 'health-metric-value warning' : 'health-metric-value good';

            if (openCircuits > 0) {
                scannerStatus.className = 'health-status unhealthy';
            } else if (runningChains < healthData.chains.length || totalErrorCount > 10) {
                scannerStatus.className = 'health-status warning';
            } else {
                scannerStatus.className = 'health-status';
            }

            // Throughput
            const throughputStatus = document.getElementById('throughputHealthStatus');
            const healthTotalTx = document.getElementById('healthTotalTx');
            const healthTotalSigs = document.getElementById('healthTotalSigs');
            const totalBlocksBehind = document.getElementById('totalBlocksBehind');

            healthTotalTx.textContent = formatNumber(statsData.total_tx_scanned);
            healthTotalSigs.textContent = formatNumber(statsData.total_signatures);

            let blocksBehind = 0;
            if (statsData.chains) {
                blocksBehind = statsData.chains.reduce((sum, c) => sum + Math.max(0, c.latest_block - c.current_block), 0);
            }
            totalBlocksBehind.textContent = formatNumber(blocksBehind);
            
            if (blocksBehind > 10000) {
                totalBlocksBehind.className = 'health-metric-value bad';
                throughputStatus.className = 'health-status warning';
            } else if (blocksBehind > 1000) {
                totalBlocksBehind.className = 'health-metric-value warning';
                throughputStatus.className = 'health-status';
            } else {
                totalBlocksBehind.className = 'health-metric-value good';
                throughputStatus.className = 'health-status';
            }

            // Chain health grid
            const chainHealthGrid = document.getElementById('chainHealthGrid');
            chainHealthGrid.innerHTML = healthData.chains.map(chain => {
                let statusClass = 'healthy';
                let statusText = 'Healthy';
                if (chain.circuit_open) {
                    statusClass = 'circuit-open';
                    statusText = 'Circuit Open';
                } else if (!chain.running) {
                    statusClass = 'stopped';
                    statusText = 'Stopped';
                }

                const chainStats = statsData.chains?.find(c => c.chain === chain.name) || {};
                const behind = Math.max(0, (chainStats.latest_block || 0) - (chainStats.current_block || 0));

                return `
                    <div class="chain-health-item">
                        <div class="chain-health-header">
                            <span class="chain-health-name">${chain.name}</span>
                            <span class="chain-health-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="chain-health-details">
                            Errors: ${chain.error_count} | Behind: ${formatNumber(behind)} blocks
                        </div>
                    </div>
                `;
            }).join('');

            // Overall status
            const overallStatus = document.getElementById('overallStatus');
            const dbHealthy = healthData.database.connected;
            const scannersHealthy = openCircuits === 0 && runningChains > 0;
            
            if (!dbHealthy) {
                overallStatus.className = 'overall-status unhealthy';
                overallStatus.innerHTML = '<h2>System Unhealthy</h2><p>Database connection failed</p>';
            } else if (!scannersHealthy) {
                overallStatus.className = 'overall-status degraded';
                const issues = [];
                if (openCircuits > 0) issues.push(`${openCircuits} circuit(s) open`);
                if (runningChains === 0) issues.push('No chains running');
                overallStatus.innerHTML = `<h2>System Degraded</h2><p>${issues.join(', ')}</p>`;
            } else if (totalErrorCount > 50 || blocksBehind > 5000) {
                overallStatus.className = 'overall-status degraded';
                overallStatus.innerHTML = '<h2>System Degraded</h2><p>High error rate or falling behind</p>';
            } else {
                overallStatus.className = 'overall-status healthy';
                overallStatus.innerHTML = '<h2>System Healthy</h2><p>All systems operational</p>';
            }
        }

        async function fetchLogs() {
            try {
                const resp = await fetch('/api/logs');
                const logs = await resp.json();
                
                const container = document.getElementById('logContainer');
                if (!logs || logs.length === 0) {
                    container.innerHTML = '<p style="color: #888; text-align: center;">No logs yet.</p>';
                    return;
                }

                container.innerHTML = logs.map(entry => {
                    const level = entry.level || 'INFO';
                    let msgClass = 'log-message';
                    if (level === 'ERROR') {
                        msgClass += ' error';
                    } else if (level === 'WARN') {
                        msgClass += ' warning';
                    }
                    return `<div class="log-entry">
                        <span class="log-timestamp">${entry.timestamp}</span>
                        <span class="log-level-badge ${level}">${level}</span>
                        <span class="${msgClass}">${entry.message}</span>
                    </div>`;
                }).join('');
                
                // Auto-scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch (e) {
                console.error('Failed to fetch logs:', e);
            }
        }

        // Initial load and intervals
        fetchStats();
        fetchDuplicates();
        setInterval(fetchStats, 3000);
        setInterval(fetchDuplicates, 15000);
        setInterval(() => {
            if (currentMainTab === 'logs') {
                fetchHealth();
                fetchLogs();
            }
        }, 2000);
    </script>
</body>
</html>
